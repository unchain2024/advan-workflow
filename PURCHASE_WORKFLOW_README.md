# 仕入れワークフロー実装完了

## 実装概要

仕入れ納品書PDFから情報を抽出し、締め日に基づいて仕入れスプレッドシートに自動記入するシステムを実装しました。

## 実装されたファイル

### バックエンド

1. **`src/purchase_extractor.py`** (新規作成)
   - `PurchaseInvoice`: 仕入れ納品書のデータモデル
   - `PurchaseItem`: 仕入れ明細行のデータモデル
   - `PurchaseExtractor`: Vision API + Geminiを使用した抽出クラス
   - 海外輸入の自動判定機能

2. **`src/utils.py`** (新規作成)
   - `calculate_target_month()`: 締め日に基づく記入対象月の計算
   - `parse_year_month()`: 日付文字列の変換

3. **`src/sheets_client.py`** (拡張)
   - `PaymentTerms`: 締め日マスターのデータモデル
   - `get_payment_terms()`: 締め日マスターから支払条件を取得
   - `save_purchase_record()`: 仕入れスプレッドシートへの書き込み（1行または2行）

4. **`src/config.py`** (拡張)
   - 仕入れスプレッドシートの環境変数追加
   - 締め日マスタースプレッドシートの環境変数追加

5. **`backend-api/routes/purchase.py`** (新規作成)
   - `POST /api/process-purchase-pdf`: 仕入れPDF処理
   - `POST /api/save-purchase-record`: スプレッドシート保存

6. **`backend-api/main.py`** (拡張)
   - 仕入れルーターの登録

### フロントエンド

1. **`frontend-react/src/types/index.ts`** (拡張)
   - `PurchaseInvoice`: 仕入れ納品書の型定義
   - `PaymentTerms`: 締め日マスターの型定義
   - `ProcessPurchasePDFResponse`: API応答の型定義

2. **`frontend-react/src/api/client.ts`** (拡張)
   - `processPurchasePDF()`: 仕入れPDF処理API
   - `savePurchaseRecord()`: スプレッドシート保存API

3. **`frontend-react/src/pages/PurchasePage.tsx`** (実装)
   - PDFアップロードUI
   - 抽出結果表示（仕入先情報、金額、締め日、記入対象月）
   - 海外輸入バッジ表示
   - スプレッドシート保存ボタン

### その他

1. **`.env.example`** (更新)
   - 仕入れ関連の環境変数のドキュメント追加

## 主要機能

### 1. PDF抽出（Vision API + Gemini）

- **発行元の会社名を抽出**: 納品書の**下部**に記載されている発行元（仕入先）を抽出
- **海外輸入の自動判定**:
  - 住所に海外キーワード（中国、韓国、USA等）が含まれる
  - 消費税が0円
  - Geminiの判定結果
- **関税額の抽出**: 「関税」「関税込」などのキーワードで金額を検索

### 2. 締め日計算

- **締め日マスター**から会社ごとの締め日を取得
- **記入対象月の計算ロジック**:
  - 「月末」締め: 納品日の月に記入
  - 「N日」締め: 納品日 <= N日 → その月、納品日 > N日 → 翌月

  例（20日締め）:
  - 2月6日 → 2月分に記入
  - 2月25日 → 3月分に記入

### 3. スプレッドシート書き込み

#### 国内仕入れ（1行）
- 「発生」列: 税抜金額
- 「消費税」列: 消費税額

#### 海外輸入（2行）
- **1行目**: 関税なしの金額
  - 発生: 税抜金額
  - 消費税: 税抜金額 × 10%
- **2行目**: 関税ありの金額
  - 発生: 税抜金額 + 関税額
  - 消費税: (税抜金額 + 関税額) × 10%

### 4. エラーハンドリング

- **会社名が見つからない場合**: 新規行を自動追加
- **締め日マスターに登録がない場合**: デフォルト「月末締め」で処理
- **月の列が見つからない場合**: 404エラーを返却

## 環境変数の設定

`.env`ファイルに以下を追加してください:

```bash
# 仕入れ管理スプレッドシート
PURCHASE_SPREADSHEET_ID=your_purchase_spreadsheet_id
PURCHASE_SHEET_NAME=仕入れ管理

# 締め日マスタースプレッドシート
PURCHASE_TERMS_SPREADSHEET_ID=your_purchase_terms_spreadsheet_id
PURCHASE_TERMS_SHEET_NAME=締め日マスター
```

## スプレッドシート構造

### 仕入れスプレッドシート

| 相手方 | 金額 | 2026年1月 ||||  2026年2月 |||| ... |
|--------|------|------|------|------|------|------|------|------|------|-----|
|        |      | 発生 | 消費税 | 消滅 | 残高 | 発生 | 消費税 | 消滅 | 残高 | ... |
| 会社A  |      | 10000| 1000 | 5000 | 6000 | ...  | ...  | ...  | ...  | ... |
| 会社B  |      | 20000| 2000 | 0    | 22000| ...  | ...  | ...  | ...  | ... |

- **Row 1**: 月ヘッダー（結合セル）
- **Row 2**: サブヘッダー（相手方、金額、発生、消費税、消滅、残高）
- **Row 3以降**: 会社データ
- **月ごとに4列**: 発生、消費税、消滅、残高

### 締め日マスタースプレッドシート

| 仕入先名 | 締め日 | 支払日 | 支払方法 | 備考 |
|----------|--------|--------|----------|------|
| 株式会社A| 月末   | 翌月末 | 銀行振込 |      |
| 株式会社B| 20日   | 翌月10日| 銀行振込 |      |

- **仕入先名**: 正規化マッチング（法人格・敬称を除去して検索）
- **締め日**: 「月末」または「N日」形式
- **支払日**: 「翌月末」「翌月N日」など

## 使用方法

### 1. バックエンドAPI起動

```bash
cd backend-api
uvicorn main:app --reload
```

### 2. フロントエンド起動

```bash
cd frontend-react
npm run dev
```

### 3. 仕入れページにアクセス

- URL: http://localhost:3000/purchase
- 仕入れ納品書PDFをドラッグ&ドロップ
- 処理完了後、スプレッドシートに保存

## API エンドポイント

### POST `/api/process-purchase-pdf`

仕入れ納品書PDFを処理して情報を抽出

**リクエスト**:
- `multipart/form-data`
- `file`: PDFファイル

**レスポンス**:
```json
{
  "purchase_invoice": {
    "date": "2025/02/06",
    "supplier_name": "株式会社フクイ",
    "supplier_address": "中国広東省東莞市...",
    "slip_number": "123456",
    "items": [...],
    "subtotal": 12838,
    "tax": 0,
    "total": 12838,
    "customs_duty": 0,
    "is_overseas": true
  },
  "payment_terms": {
    "supplier_name": "株式会社フクイ",
    "closing_day": "月末",
    "payment_day": "翌月末",
    "payment_method": "銀行振込"
  },
  "target_year_month": "2025年2月",
  "is_overseas": true,
  "records_count": 2,
  "purchase_pdf_url": "/output/purchase_..."
}
```

### POST `/api/save-purchase-record`

仕入れスプレッドシートにデータを保存

**リクエスト**:
```json
{
  "supplier_name": "株式会社フクイ",
  "target_year_month": "2025年2月",
  "purchase_invoice": { ... }
}
```

**レスポンス**:
```json
{
  "success": true,
  "message": "仕入れデータを '2025年2月' に保存しました"
}
```

## テスト

### サンプルPDF

- ファイル: `/home/ebi/Downloads/202503支払い明細/0206フクイ_一和多_.pdf`
- 発行元: 株式会社フクイ（中国）
- 日付: 2025年02月06日
- 合計: 12,838円
- 特徴: 海外輸入、消費税0円

### 期待される動作

1. **抽出結果**:
   - 仕入先名: 株式会社フクイ
   - 海外フラグ: true
   - 記入対象月: 2025年2月（締め日に応じて）

2. **スプレッドシート記録**:
   - 2行に記録（関税なし・関税あり）
   - 「発生」列と「消費税」列に値が加算される

## 実装のポイント

### 売上計上システムとの差異

| 項目 | 売上計上 | 仕入れ |
|------|---------|--------|
| 会社名 | 宛先（上部） | 発行元（下部） |
| 列構成 | 月ごとに異なる | 月ごとに4列固定 |
| 行数 | 1行 | 1-2行 |
| 月判定 | 納品日の月 | 締め日基準 |
| マスター | 会社マスター | 締め日マスター |

### 海外輸入の2行記録

- 1行目: 関税を含まない金額（通関前の金額）
- 2行目: 関税を含む金額（通関後の金額）
- 両方の行のA列に同じ会社名を記入

### 締め日計算の例

**20日締め翌月10日払いの場合:**
- 1/21 〜 2/20 の納品 → 2月分に記入 → 3月10日に支払い
- 2/21 〜 3/20 の納品 → 3月分に記入 → 4月10日に支払い

## トラブルシューティング

### Q: 会社名が見つからない
A: 新規行が自動追加されます。スプレッドシートで確認してください。

### Q: 海外判定が誤っている
A: フロントエンドで手動編集機能を追加する予定です（Phase 3）。

### Q: 月の列が見つからない
A: スプレッドシートに該当月の列を追加してください。

## 今後の拡張予定（Phase 3-4）

1. **編集機能**: 抽出結果を手動で編集できるフォーム
2. **バリデーション強化**: 金額の範囲チェック、日付の妥当性検証
3. **一括処理**: 複数PDFの同時処理
4. **履歴管理**: 処理履歴の記録と照会

## 関連ドキュメント

- 計画書: プランモードで作成された詳細な実装計画
- 売上計上システム: `src/`配下の既存コード参照
